<template class="task-template">
    <section id="upload-section" class="section js-section u-category-native-ui">

        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <h2 class="main-title">Upload Image Session to
                        <span id="server_name_tlbr"></span>
                    </h2>

                    <nav>
                        <div class="nav nav-tabs" id="nav-tab" role="tablist">
                            <a class="nav-item nav-link active" data-toggle="tab" href="#nav-project" role="tab" aria-controls="nav-project" aria-selected="true">Project / Data Selection</a>
                            <a class="nav-item nav-link disabled" data-toggle="tab" href="#nav-verify" role="tab" aria-controls="nav-verify" aria-selected="false">Confirm Details</a>
                            <a class="nav-item nav-link disabled" data-toggle="tab" href="#nav-summary" role="tab" aria-controls="nav-summary" aria-selected="false">Upload to XNAT</a>
                        </div>
                    </nav>
                    <div class="tab-content" id="nav-tabContent">
                        <div class="tab-pane fade show active" id="nav-project" role="tabpanel" aria-labelledby="nav-home-tab">
                            <div class="row">
                                <div class="col-6">
                                    <h2 class="section-title search-inline">Select Project</h2>
                                </div>
                                <div class="col-6">
                                    <div class="filter-control title-inline">
                                        <input type="text" id="upload-project-filter" onkeyup="" placeholder="Filter" class="form-control">
                                    </div>
                                </div>

                                <div class="col-12">
                                    <ul id="upload-project" class="choose-list"></ul>
                                </div>
                            </div>
                            

                            <div class="">
                                <div class="row">
                                    <div class="col-5">
                                        <h2 class="section-title">Project Settings</h2>

                                        <div id="project_settings_tbl_wrap"><p>Select a project to view settings</p></div>

                                        <script type="text/html" id="project_settings_tbl_tpl">
                                            <table id="project_settings_tbl" class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th scope="col">Project</th>
                                                        <th scope="col" class="text-right"><%project_settings.project.name%></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>Subjects</th>
                                                        <td class="text-right"><%project_settings.subjects.length%></td>
                                                    </tr>
                                                    <tr>
                                                        <td>Image Sessions</th>
                                                        <td class="text-right"><%project_settings.sessions.length%></td>
                                                    </tr>

                                                    <tr>
                                                        <td>Site-wide Anon Script</th>
                                                        <td class="text-right">
                                                            <%if(site_wide_settings.anon_script !== false) {%>
                                                                <span title="<%site_wide_settings.anon_script.replace(/"/g, '&quot;')%>">✔</span>
                                                            <%} else {%>
                                                                N/A
                                                            <%}%>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td>Project Anon Script</th>
                                                        <td class="text-right">
                                                            <%if(project_settings.anon_script !== false) {%>
                                                                <span title="<%project_settings.anon_script.replace(/"/g, '&quot;')%>">✔</span>
                                                            <%} else {%>
                                                                N/A
                                                            <%}%>
                                                        </td>
                                                    </tr>
                                                    
                                                    <tr>
                                                        <td>Site-wide Series Import Filter</th>
                                                        <td class="text-right">
                                                            <%if(site_wide_settings.series_import_filter !== false) {%>
                                                                <span title="<%site_wide_settings.series_import_filter.replace(/"/g, '&quot;')%>">✔</span>
                                                            <%} else {%>
                                                                N/A
                                                            <%}%>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td>Project Series Import Filter</th>
                                                        <td class="text-right">
                                                            <%if(project_settings.series_import_filter !== false) {%>
                                                                <span title="<% (JSON.stringify(project_settings.series_import_filter)).replace(/"/g, '&quot;') %>">✔</span>
                                                            <%} else {%>
                                                                N/A
                                                            <%}%>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td>Upload destination</th>
                                                        <td class="text-right"><%project_settings.upload_destination%></td>
                                                    </tr>
                                                    <tr>
                                                        <td>Date Verification Required</th>
                                                        <td class="text-right">
                                                            <%if(site_wide_settings.require_date || project_settings.require_date) {%>
                                                                ✔
                                                            <%} else {%>
                                                                ✖
                                                            <%}%>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </script>

                                        
                                    </div>
                                    <div class="col-6 offset-1">
                                        <h2 class="section-title">Select Data To Upload (Choose a Folder)</h2>
                                        <p>Selected folder must contain one or more sets of uncompressed DICOM image files. 
                                            Selected folder can contain files in a flat directory structure or in subfolders. 
                                        </p>

                                        <div class="form-group">
                                            <div class="input-group">
                                                <input type="text" id="upload_folder" value="" class="form-control col-9 settings-input" readonly>
                                                <div class="col-3">
                                                    <label class="input-group-btn">
                                                        <span class="btn btn-blue">
                                                            Browse
                                                            <input type="file" id="file_upload_folder" style="display: none" webkitdirectory
                                                                directory>
                                                        </span>
                                                    </label>
                                                </div>
            
                                            </div>
                                        </div>
            
            
                                        <!--<button class="btn btn-blue" id="test-upload" type="button">Test upload</button>-->
            
                                        <progress id="dicom_parse_progress" class="hidden" value="0" max="100"></progress>
                                    </div>
                                </div>
                            </div>

                            <div class="row action-button-row">
                                <div class="col-12">
                                    <div class="text-right button-row">
                                        <button class="btn btn-gray float-left hidden" type="button" data-toggle="modal" data-target="#new-subject">Create new subject</button>

                                        <button type="button" class="btn btn-gray" data-href="home.html" type="button">Cancel</button>
                                        <button type="button" class="btn btn-blue js_next disabled">Next <i class="fas fa-angle-right"></i></button>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                        

                        <div class="tab-pane fade" id="nav-verify" role="tabpanel" aria-labelledby="nav-verify">
                            <div id="custom_upload">
                                <div class="col" id="anon_variables">

                                    <div class="form-group row">
                                        <label class="col-sm-2 col-form-label">
                                            <b>Project</b>:
                                        </label>
                                        <div class="input-group col-sm-6">
                                            <input class="form-control" type="text" name="project" id="var_project"
                                                value="xxx" required readonly>
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label class="col-sm-2 col-form-label">
                                            <b>Subject</b>:
                                        </label>
                                        <div class="input-group col-sm-6">
                                            <select class="form-control" id="var_subject" name="subject"
                                                style="width: 40%" required></select>
                                            <button class="btn btn-gray" type="button" data-toggle="modal"
                                                data-target="#new-subject">Create new subject</button>
                                        </div>
                                    </div>



                                    <div class="form-group row" id="experiment_label_container">
                                        <label for="experiment_label" class="col-sm-2 col-form-label">
                                            <b>Experiment Label
                                                <br>(Session)</b>:</label>
                                        <div class="input-group col-sm-10">
                                            <input class="form-control" type="text" name="experiment_label"
                                                id="experiment_label" value="" required>
                                            <div class="invalid-feedback">
                                                Allowed characters: alphanumeric, dash(-) and underscore(_)
                                            </div>
                                            <small>This field has been auto-populated. If you specify a session label
                                                that matches a
                                                session already in this project, XNAT will attempt to merge selected
                                                scans into
                                                the existing session</small>

                                        </div>
                                    </div>
                                    <div id="additional-upload-fields"></div>

                                    <br>
                                    <br>

                                </div>

                                <div class="col">
                                    <h2 class="section-title">Confirm The Scans To Be Uploaded</h2>
                                    <p>Note: Unchecked scans will not be uploaded</p>
                                    <table class="table table-bordered" id="image_session"></table>
                                </div>

                                <div class="col">
                                    <h2 class="section-title">Session Summary:</h2>
                                    <p id="session_info"></p>
                                </div>

                                <div class="row action-button-row">
                                    <div class="col-12">
                                        <div class="text-right button-row">
                                            <button type="button" data-href="home.html" class="btn btn-gray">Cancel</button>
                                            <button type="button" class="btn btn-gray js_prev" type="button">
                                            <i class="fas fa-angle-left"></i> Prev</button>
                                            <button type="button" class="btn btn-blue js_upload">Upload</button>
                                        </div>
                                    </div>
                                </div>
                            </div><!-- #custom_upload -->

                            <div id="quick_upload">
                                <div class="col">
                                    <h2>Quick Upload</h2>
                                    <p>A "quick upload" process assumes that you do not need to make any modifications 
                                        to your session or scan data, including visual PHI inspection or pixel 
                                        anonymization, before uploading to your XNAT. You can switch to the 
                                        Custom Upload Process if you wish.  </p>
                                </div>
                                

                                <div class="col">
                                    <table class="table table-bordered" id="selected_session_tbl"></table>
                                </div>

                                <div class="row action-button-row" style="justify-content: space-between; padding: 10px;">
                                    <div class="button-row">
                                        <label for="upload_overwrite_method" style="font-weight: bold; margin: 0 10px 0 0;">How should XNAT handle overwriting existing data?</label>
                                        <select required id="upload_overwrite_method" style="display: inline-block; width: auto;" class="form-control form-control-sm">
                                            <option value="">Select</option>
                                            <option value="append">Append to Existing Data</option>
                                            <option value="delete">Overwrite Existing Data</option>
                                            <option value="none">Ignore Duplicate Data (Default)</option>
                                        </select>
                                    </div>

                                    <div class="button-row">
                                        <button type="button" data-href="home.html"
                                            class="btn btn-gray">Cancel</button>
                                        <button type="button" class="btn btn-gray js_prev" type="button">
                                            <i class="fas fa-angle-left"></i> Prev</button>
                                        <button type="button" class="btn btn-blue js_upload">Upload</button>
                                    </div>
                                </div>

                            </div><!-- #quick_upload -->

                        </div>
                        <div class="tab-pane fade" id="nav-summary" role="tabpanel" aria-labelledby="nav-profile-tab">
                            <h2 class="section-title">Summary</h2>

                            <div class="row">
                                <br>
                                <br>
                                <div class="col" id="summary_info"></div>
                            </div>
                           
                        </div>
                    </div>

                </div>
            </div>
            <!-- Modal -->
            <div class="modal fade" id="new-subject" tabindex="-1" role="dialog" aria-labelledby="subject-new" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLongTitle">Create new Subject</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <i class="far fa-window-close"></i>
                            </button>
                        </div>
                        <form id="form_new_subject">
                            <div class="modal-body">

                                <div class="row">
                                    <div class="col">
                                        <label class="col-form-label">Primary Project:</label>
                                    </div>
                                    <div class="col">
                                        <span id="new_subject_project_id"></span>
                                        <input type="hidden" name="project_id" value="">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col">
                                            <label class="col-form-label">Subject’s ID within this project:</label>
                                        </div>
                                        <div class="col">
                                            <input type="text" name="subject_label" class="form-control" required>
                                            <div class="invalid-feedback">
                                                Allowed characters: alphanumeric, dash(-) and underscore(_)
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col">
                                            <label class="col-form-label">Subject’s research group within this project:</label>
                                        </div>
                                        <div class="col">
                                            <input type="text" name="group" class="form-control">
                                            <div class="invalid-feedback">
                                                Allowed characters: alphanumeric, dash(-) and underscore(_)
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-gray" type="button" data-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-blue">Add New Subject</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <!-- Modal -->
            <div class="modal fade" id="note" tabindex="-1" role="dialog" aria-labelledby="note" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLongTitle">Add Note</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <i class="far fa-window-close"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div class="row">
                                    <div class="col">
                                        <textarea placeholder="Add Note" rows="5"></textarea>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-blue">Add Note</button>
                        </div>
                    </div>
                </div>
            </div>

            
            <!-- Modal -->
            <div class="modal fade" data-backdrop="static" data-keyboard="false" id="session-selection" tabindex="-1" role="dialog" aria-labelledby="session-selection" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg modal-xl" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLongTitle">Please select one session</h5>
                            
                            <!-- <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <i class="far fa-window-close"></i>
                            </button> -->
                        </div>
                        <div class="modal-body">
                            <p>Select one or more sessions to upload</p>

                            <p class="notice" data-display="require_date"><span>&#x26A0;</span> Project requires Date Verification before upload can continue</p>
                            
                            <form>
                                <div class="row">
                                    <div class="col">
                                        <table class="table table-bordered" id="found_sessions"></table>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <div class="modal-footer">
                            <div class="mr-auto" data-display="require_date">
                                <input type="checkbox" class="magic-checkbox" name="skip_session_date_validation" id="skip_session_date_validation">
                                <label for="skip_session_date_validation">I don't know the dates of these sessions</label>
                            </div>
                            <button type="button" class="btn btn-gray js_cancel_session_selection" type="button" data-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-gray js_custom_upload" type="button" disabled>Custom Upload</button>
                            <button type="button" class="btn btn-blue js_quick_upload" type="button" disabled>Quick Upload</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <script type="text/javascript">
            require('./renderer-process/upload')

            Helper.pageLoadTrigger('#upload-section'); 
        </script>

    </section>
</template>